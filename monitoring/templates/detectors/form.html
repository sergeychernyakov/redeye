<!-- templates/detectors/form.html -->
<form method="post" action="{% url 'create_detector' map.id %}">
  {% csrf_token %}

  <input type="hidden" id="area" name="area" value="{{ area.id }}">

  <!-- Ошибки, не связанные с конкретными полями -->
  {% if form.non_field_errors %}
      <div class="alert alert-danger">
          {{ form.non_field_errors }}
      </div>
  {% endif %}

  <!-- Имя детектора -->
  <div class="form-group">
    <label for="name">Название детектора:</label>
    <input type="text" class="form-control" id="name" name="name" value="{{ form.name.value }}" required>
    <!-- Ошибки для поля 'name' -->
    {% if form.name.errors %}
      <div class="text-danger">
        {{ form.name.errors }}
      </div>
    {% endif %}
  </div>
  
  <!-- RTSP URL -->
  <div class="form-group">
    <label for="rtsp-url">RTSP URL:</label>
    <input type="text" class="form-control" id="rtsp-url" name="rtsp_url" placeholder="Введите RTSP URL (например, rtsp://...)" value="{{ form.rtsp_url.value }}" required required oninput="fillFromRTSP()">
    <!-- Ошибки для поля 'rtsp_url' -->
    {% if form.rtsp_url.errors %}
      <div class="text-danger">
        {{ form.rtsp_url.errors }}
      </div>
    {% endif %}
  </div>

  <!-- VPN параметры (IP, логин, пароль) -->
  <div class="form-group">
    <label for="vpn-server-ip">VPN IP:</label>
    <input type="text" class="form-control" id="vpn-server-ip" name="vpn_server_ip" placeholder="Введите IP VPN сервера" value="{{ form.vpn_server_ip.value }}" required required oninput="fillFromRTSP()">
    <!-- Ошибки для поля 'vpn_server_ip' -->
    {% if form.vpn_server_ip.errors %}
      <div class="text-danger">
        {{ form.vpn_server_ip.errors }}
      </div>
    {% endif %}
  </div>

  <div class="form-group">
    <label for="vpn-username">VPN Логин:</label>
    <input type="text" class="form-control" id="vpn-username" name="vpn_username" placeholder="Введите VPN логин" value="{{ form.vpn_username.value }}" required required oninput="fillFromRTSP()">
    <!-- Ошибки для поля 'vpn_username' -->
    {% if form.vpn_username.errors %}
      <div class="text-danger">
        {{ form.vpn_username.errors }}
      </div>
    {% endif %}
  </div>

  <div class="form-group">
    <label for="vpn-password">VPN Пароль:</label>
    <input type="password" class="form-control" id="vpn-password" name="vpn_password" placeholder="Введите VPN пароль" value="{{ form.vpn_password.value }}" required required oninput="fillFromRTSP()">
    <!-- Ошибки для поля 'vpn_password' -->
    {% if form.vpn_password.errors %}
      <div class="text-danger">
        {{ form.vpn_password.errors }}
      </div>
    {% endif %}
  </div>

  <!-- Автозаполненные поля (IP-адрес и порт) -->
  <div class="form-group">
    <label for="ip">IP (*):</label>
    <input type="text" class="form-control" id="ip" name="ip" placeholder="IP-адрес детектора" value="{{ form.ip.value }}" required readonly>
    <!-- Ошибки для поля 'ip' -->
    {% if form.ip.errors %}
      <div class="text-danger">
        {{ form.ip.errors }}
      </div>
    {% endif %}
  </div>

  <div class="form-group">
    <label for="port">Порт (*):</label>
    <input type="text" class="form-control" id="port" name="port" placeholder="Порт детектора" value="{{ form.port.value }}" required readonly>
    <!-- Ошибки для поля 'port' -->
    {% if form.port.errors %}
      <div class="text-danger">
        {{ form.port.errors }}
      </div>
    {% endif %}
  </div>

  <!-- Дополнительные параметры (скрытые по умолчанию) -->
  <div id="additional-fields" style="display:none;">
    <div class="form-group">
      <label for="latitude">Широта:</label>
      <input type="text" class="form-control" id="latitude" name="latitude" placeholder="Введите широту" value="{{ form.latitude.value }}" readonly>
      <!-- Ошибки для поля 'latitude' -->
      {% if form.latitude.errors %}
        <div class="text-danger">
          {{ form.latitude.errors }}
        </div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="longitude">Долгота:</label>
      <input type="text" class="form-control" id="longitude" name="longitude" placeholder="Введите долготу" value="{{ form.longitude.value }}" readonly>
      <!-- Ошибки для поля 'longitude' -->
      {% if form.longitude.errors %}
        <div class="text-danger">
          {{ form.longitude.errors }}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Кнопка для показа/скрытия дополнительных параметров -->
  <button type="button" class="btn btn-secondary d-block mb-2" onclick="toggleAdditionalFields()">
    <span id="toggle-icon" class="bi bi-chevron-down"></span> Дополнительные параметры
  </button>
  
  <!-- Кнопка сохранения на новой строке -->
  <div class="form-group">
    <button type="submit" class="btn btn-primary d-block">{% if detector %}Сохранить изменения{% else %}Создать{% endif %}</button>
  </div>
</form>

<!-- Скрипты для автозаполнения и скрытия/показа дополнительных полей -->
<script>
  function fillFromRTSP() {
      var rtspUrl = document.getElementById('rtsp-url').value;
  
      // Примерная логика для парсинга RTSP URL и заполнения IP и порта
      var urlParts = rtspUrl.match(/rtsp:\/\/(.*):(.*)@(.*):(.*)\//);
      if (urlParts && urlParts.length === 5) {
          var username = urlParts[1];
          var password = urlParts[2];
          var ip = urlParts[3];
          var port = urlParts[4];
  
          document.getElementById('ip').value = ip;
          document.getElementById('port').value = port;
      }
  }

  function fillFromVPN() {
      var vpnIp = document.getElementById('vpn-server-ip').value;
      var vpnUsername = document.getElementById('vpn-username').value;
      var vpnPassword = document.getElementById('vpn-password').value;
  
      // Логика может расширяться для автозаполнения других полей, если необходимо
      // Например, можно использовать данные VPN для других целей
  }
  
  function toggleAdditionalFields() {
      var additionalFields = document.getElementById('additional-fields');
      var toggleIcon = document.getElementById('toggle-icon');
  
      if (additionalFields.style.display === 'none') {
          additionalFields.style.display = 'block';
          toggleIcon.className = 'bi bi-chevron-up';  // Меняем иконку на стрелку вверх
      } else {
          additionalFields.style.display = 'none';
          toggleIcon.className = 'bi bi-chevron-down';  // Меняем иконку на стрелку вниз
      }
  }
  </script>
  